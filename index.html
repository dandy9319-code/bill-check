<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åˆ†å¸³å°å¹«æ‰‹ v2.1.2</title>
    
    <!-- PWA è¨­å®š (éš±è—ç€è¦½å™¨å·¥å…·åˆ—) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="åˆ†å¸³å°å¹«æ‰‹">

    <!-- è¨­å®š App Icon (ä½¿ç”¨ CDN åŠ é€Ÿä¸¦æŒ‡å®šå°ºå¯¸ï¼Œå·²ä¿®æ­£ URL ç·¨ç¢¼å•é¡Œ) -->
    <link rel="icon" href="https://wsrv.nl/?url=https%3A%2F%2Fdrive.google.com%2Fuc%3Fexport%3Dview%26id%3D1dhOMUAE1lZ2faIDdyd7jtJZbZf-f1C6u&w=192&output=png" type="image/png">
    <link rel="apple-touch-icon" href="https://wsrv.nl/?url=https%3A%2F%2Fdrive.google.com%2Fuc%3Fexport%3Dview%26id%3D1dhOMUAE1lZ2faIDdyd7jtJZbZf-f1C6u&w=180&output=png">
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ React èˆ‡ Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- å¼•å…¥ html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        html, body { overflow-x: hidden; width: 100%; }
        input { font-size: 16px !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #f2cc8f; border-radius: 20px; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes modalFade {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-overlay {
            animation: modalFade 0.2s ease-out forwards;
        }
    </style>
</head>
<body class="bg-[#FFF9F0] text-[#4A403A]">
    <!-- 
        å‰µä½œè€…: dandy
        IG:dandy0906
    -->
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useRef } = React;

        /**
         * ç‰ˆæœ¬: v2.1.2
         * å°ˆæ¡ˆ: åˆ†å¸³å°å¹«æ‰‹ (Icon Fix & Title Update)
         * ä¿®æ”¹é‡é»:
         * 1. ä¿®æ­£ HTML head ä¸­çš„ App Icon é€£çµ (URL encoding)ï¼Œè§£æ±ºåŠ å…¥æ¡Œé¢ä¸é¡¯ç¤º Logo çš„å•é¡Œã€‚
         * 2. æ‡‰ç”¨ç¨‹å¼åç¨±å…¨é¢æ›´æ–°ç‚ºã€Œåˆ†å¸³å°å¹«æ‰‹ã€ã€‚
         */

        // --- Assets ---
        const LOGO_URL = "https://drive.google.com/uc?export=view&id=1dhOMUAE1lZ2faIDdyd7jtJZbZf-f1C6u";
        const PROXY_LOGO_URL = `https://wsrv.nl/?url=${encodeURIComponent(LOGO_URL)}&w=100&output=png`;

        const QR_CODE_URL = "https://drive.google.com/uc?export=view&id=1_gZxk_FmAJez9E_bvr2OeytzG1du5rvA";
        const PROXY_QR_CODE_URL = `https://wsrv.nl/?url=${encodeURIComponent(QR_CODE_URL)}&w=300&output=png`;
        
        const GUIDE_IMG_URL = "https://drive.google.com/uc?export=view&id=1c_xatKsfeRrbY51LTT5XAdkiXY9j5QyW";
        const PROXY_GUIDE_IMG_URL = `https://wsrv.nl/?url=${encodeURIComponent(GUIDE_IMG_URL)}`;

        // --- Icon Components ---
        const IconBase = ({ children, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Plus = (props) => <IconBase {...props}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></IconBase>;
        const User = (props) => <IconBase {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></IconBase>;
        const Receipt = (props) => <IconBase {...props}><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1-2-1Z"></path><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"></path><path d="M12 17V7"></path></IconBase>;
        const DollarSign = (props) => <IconBase {...props}><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></IconBase>;
        const Coffee = (props) => <IconBase {...props}><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></IconBase>;
        const Share2 = (props) => <IconBase {...props}><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></IconBase>;
        const Tag = (props) => <IconBase {...props}><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></IconBase>;
        const Settings = (props) => <IconBase {...props}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></IconBase>;
        const Circle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"></circle></IconBase>;
        const Camera = (props) => <IconBase {...props}><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></IconBase>;
        const X = (props) => <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></IconBase>;
        const LinkIcon = (props) => <IconBase {...props}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></IconBase>;

        // --- Constants & Enums ---
        const MODES = { SPLIT_ALL: 'SPLIT_ALL', SEPARATE: 'SEPARATE' };
        const DISCOUNT_TYPES = { NONE: 'NONE', PERCENT: 'PERCENT', AMOUNT: 'AMOUNT' };
        const DISCOUNT_TIMING = { BEFORE_TAX: 'BEFORE_TAX', AFTER_TAX: 'AFTER_TAX' };
        const DEFAULT_SERVICE_CHARGE = 10;

        // --- Logic ---
        const formatCurrency = (amount) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
        const formatDate = () => { const d = new Date(); return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }

        const getAvatarStyle = (index) => {
            const styles = ['bg-rose-100 text-rose-600', 'bg-teal-100 text-teal-600', 'bg-amber-100 text-amber-600', 'bg-sky-100 text-sky-600'];
            return styles[index % styles.length];
        };

        const calculateBill = (people, sharedAmount, takeoutAmount, serviceChargeRate, mode, discountType, discountValue, discountTiming) => {
            const count = people.length;
            const totalWeight = people.reduce((acc, p) => acc + (p.weight || 1), 0);

            if (totalWeight === 0) return { peopleResults: [], totals: { subtotal: 0, serviceFee: 0, grandTotal: 0 } };

            const taxMultiplier = 1 + (serviceChargeRate / 100);
            let sharedWithTax = 0;
            let discountAmount = 0;
            let totalServiceFee = 0;

            if (discountType === DISCOUNT_TYPES.AMOUNT) {
                const amount = discountValue || 0;
                discountAmount = amount;
                if (discountTiming === DISCOUNT_TIMING.BEFORE_TAX) {
                    const taxableAmount = Math.max(0, sharedAmount - amount);
                    sharedWithTax = taxableAmount * taxMultiplier;
                    totalServiceFee = taxableAmount * (serviceChargeRate / 100);
                } else {
                    const baseTaxed = sharedAmount * taxMultiplier;
                    sharedWithTax = Math.max(0, baseTaxed - amount);
                    totalServiceFee = sharedAmount * (serviceChargeRate / 100);
                }
            } else if (discountType === DISCOUNT_TYPES.PERCENT) {
                const percentOff = discountValue || 0;
                const validPercentOff = Math.min(100, Math.max(0, percentOff));
                const percentToPay = 100 - validPercentOff;
                const baseTaxed = sharedAmount * taxMultiplier;
                const afterDiscount = baseTaxed * (percentToPay / 100);
                sharedWithTax = afterDiscount;
                discountAmount = baseTaxed - afterDiscount; 
                totalServiceFee = sharedAmount * (serviceChargeRate / 100); 
            } else {
                sharedWithTax = sharedAmount * taxMultiplier;
                totalServiceFee = sharedAmount * (serviceChargeRate / 100);
            }

            const sharedPerWeightUnit = sharedWithTax / totalWeight;
            const takeoutPerPerson = takeoutAmount / count;

            let totalIndividualBase = 0;
            let totalIndividualTax = 0;

            const peopleResults = people.map(person => {
                let personalBase = 0;
                let personalWithTax = 0;
                const weight = person.weight || 1;

                if (mode === MODES.SEPARATE) {
                    personalBase = parseFloat(person.personalAmount) || 0;
                    personalWithTax = personalBase * taxMultiplier;
                    totalIndividualTax += (personalBase * (serviceChargeRate / 100));
                }

                totalIndividualBase += personalBase;
                const myShared = sharedPerWeightUnit * weight;
                const finalPay = myShared + personalWithTax + takeoutPerPerson;
                
                return {
                    ...person,
                    breakdown: { shared: myShared, personal: personalWithTax, takeout: takeoutPerPerson },
                    finalPay: Math.round(finalPay) 
                };
            });

            const grandTotal = peopleResults.reduce((acc, p) => acc + p.finalPay, 0);
            const finalServiceFee = totalServiceFee + totalIndividualTax;

            return {
                peopleResults,
                totals: { subtotal: sharedAmount + totalIndividualBase + takeoutAmount, serviceFee: finalServiceFee, grandTotal: grandTotal, discount: discountAmount }
            };
        };

        // --- UI Components ---

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white/90 backdrop-blur-md rounded-2xl shadow-sm border border-[#E6D5C8] p-4 w-full ${className}`}>
                {children}
            </div>
        );

        const InputGroup = ({ label, icon: Icon, value, onChange, placeholder, type = "number", subLabel, className = "" }) => (
            <div className="flex flex-col space-y-1">
                <label className="text-sm font-bold text-stone-600 flex justify-between items-center">
                    <span className="flex items-center gap-1.5">{Icon && <Icon size={14} className="text-[#E07A5F]" />}{label}</span>
                    {subLabel && <span className="text-[10px] text-stone-400 font-medium">{subLabel}</span>}
                </label>
                <input type={type} value={value} onChange={onChange} placeholder={placeholder} onFocus={(e) => e.target.select()} className={`w-full px-3 py-2 bg-[#FFFCF9] border border-[#E6D5C8] rounded-lg focus:ring-2 focus:ring-[#E07A5F] focus:border-[#E07A5F] outline-none transition-all text-stone-800 font-bold placeholder-stone-300 shadow-inner text-sm ${className}`} />
            </div>
        );

        const ToggleSwitch = ({ active, onClick, leftLabel, rightLabel }) => (
            <div className="flex bg-[#EFE6E0] p-1 rounded-lg relative cursor-pointer shadow-inner select-none" onClick={onClick}>
                <div className={`absolute top-1 bottom-1 w-[calc(50%-4px)] bg-white rounded-md shadow-sm transition-all duration-300 ease-out border border-[#D7CCC8] ${active === 'left' ? 'left-1' : 'left-[calc(50%+2px)]'}`} />
                <div className={`flex-1 z-10 text-center py-1.5 text-xs font-bold transition-colors ${active === 'left' ? 'text-[#E07A5F]' : 'text-stone-400'}`}>{leftLabel}</div>
                <div className={`flex-1 z-10 text-center py-1.5 text-xs font-bold transition-colors ${active === 'right' ? 'text-[#E07A5F]' : 'text-stone-400'}`}>{rightLabel}</div>
            </div>
        );

        const RadioOption = ({ selected, onClick, label }) => (
            <div onClick={onClick} className={`flex items-center gap-1 cursor-pointer transition-colors ${selected ? 'text-[#E07A5F] font-bold' : 'text-stone-400 hover:text-stone-600'}`}>
                {selected ? <CheckCircle size={14} /> : <Circle size={14} />}<span className="text-xs">{label}</span>
            </div>
        );

        const DiscountSelector = ({ type, onChangeType, value, onChangeValue, timing, onChangeTiming }) => {
            const discountLabel = useMemo(() => {
                if (!value || type !== DISCOUNT_TYPES.PERCENT) return '';
                const percentOff = parseFloat(value);
                const discountRate = (100 - percentOff) / 10;
                return discountRate % 1 === 0 ? `${discountRate}æŠ˜` : `${discountRate}æŠ˜`;
            }, [value, type]);

            return (
                <div className="space-y-2 pt-2 border-t border-[#E6D5C8]">
                    <div className="flex items-center gap-2 mb-1"><Tag size={16} className="text-[#E07A5F]" /><span className="text-sm font-bold text-stone-600">æŠ˜æ‰£è¨­å®š</span></div>
                    <div className="flex bg-[#EFE6E0] p-1 rounded-lg">
                        {[ { id: DISCOUNT_TYPES.NONE, label: 'ç„¡æŠ˜æ‰£' }, { id: DISCOUNT_TYPES.PERCENT, label: 'æ‰“æŠ˜ (%)' }, { id: DISCOUNT_TYPES.AMOUNT, label: 'æ‰£æŠµ (å…ƒ)' } ].map(opt => (
                            <button key={opt.id} onClick={() => onChangeType(opt.id)} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${type === opt.id ? 'bg-white text-[#E07A5F] shadow-sm border border-[#D7CCC8]' : 'text-stone-400 hover:text-stone-600'}`}>{opt.label}</button>
                        ))}
                    </div>
                    {type !== DISCOUNT_TYPES.NONE && (
                        <div className="animate-fade-in space-y-2">
                            <div className="flex items-center gap-2">
                                <input type="number" value={value} onChange={onChangeValue} placeholder={type === DISCOUNT_TYPES.PERCENT ? "ä¾‹å¦‚: 10 (ä»£è¡¨9æŠ˜)" : "è¼¸å…¥æ‰£é™¤é‡‘é¡"} className="flex-1 px-3 py-2 bg-[#FFFCF9] border border-orange-200 rounded-lg focus:ring-2 focus:ring-[#E07A5F] outline-none text-orange-700 font-bold text-sm shadow-inner" />
                                {type === DISCOUNT_TYPES.PERCENT && discountLabel && <span className="text-sm font-bold text-stone-400 whitespace-nowrap">{discountLabel}</span>}
                                {type === DISCOUNT_TYPES.AMOUNT && <span className="text-sm font-bold text-stone-400 whitespace-nowrap">å…ƒ</span>}
                            </div>
                            {type === DISCOUNT_TYPES.PERCENT && <div className="text-[10px] text-stone-500 bg-[#FFF9F0] p-2 rounded border border-[#E6D5C8] leading-relaxed"><span className="font-bold text-stone-600">è¨ˆç®—é‚è¼¯ï¼š</span>é‡å°å°ç£å¸¸è¦‹ç¿’æ…£ï¼Œæœå‹™è²»ä¾ã€ŒåŸåƒ¹ã€è¨ˆç®—ã€‚å…¬å¼ç‚ºï¼š(ç¸½é‡‘é¡ + 10%æœå‹™è²») - æŠ˜æ‰£ = æ‡‰ä»˜ç¸½é¡ã€‚è‹¥æ˜¯ã€Œæ‰“æŠ˜(%)ã€ï¼Œå‰‡æ˜¯é‡å°ç¸½é‡‘é¡æ‰“æŠ˜ã€‚</div>}
                            {type === DISCOUNT_TYPES.AMOUNT && <div className="flex gap-4 px-1 py-1"><RadioOption selected={timing === DISCOUNT_TIMING.BEFORE_TAX} onClick={() => onChangeTiming(DISCOUNT_TIMING.BEFORE_TAX)} label="æœå‹™è²»å‰æ‰£æŠµ" /><RadioOption selected={timing === DISCOUNT_TIMING.AFTER_TAX} onClick={() => onChangeTiming(DISCOUNT_TIMING.AFTER_TAX)} label="æœå‹™è²»å¾Œæ‰£æŠµ" /></div>}
                        </div>
                    )}
                </div>
            );
        };

        const HeaderButton = ({ icon: Icon, onClick, label }) => (
            <button 
                onClick={onClick}
                className="flex flex-col items-center justify-center gap-1 group"
                title={label}
            >
                <div className="p-2 bg-white/60 group-hover:bg-white text-[#E07A5F] rounded-lg transition-colors border border-[#E6D5C8] shadow-sm">
                    <Icon size={20} />
                </div>
                <span className="text-[9px] font-bold text-[#E07A5F] opacity-80 group-hover:opacity-100 transition-opacity">{label}</span>
            </button>
        );

        // --- Modals ---

        const ShareModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-stone-900/60 backdrop-blur-sm modal-overlay">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-xs w-full overflow-hidden flex flex-col relative">
                        <button onClick={onClose} className="absolute top-3 right-3 p-1 hover:bg-stone-100 rounded-full text-stone-400 z-10"><X size={20}/></button>
                        <div className="p-6 text-center space-y-4">
                            <h3 className="font-bold text-stone-700 text-lg flex items-center justify-center gap-2">
                                <Share2 size={20} className="text-[#E07A5F]"/> åˆ†äº«å°å¹«æ‰‹
                            </h3>
                            <div className="bg-[#FFF9F0] p-4 rounded-xl border border-[#E6D5C8] inline-block">
                                <img src={PROXY_QR_CODE_URL} crossOrigin="anonymous" alt="Scan to Share" className="w-40 h-40 object-contain mix-blend-multiply" />
                            </div>
                            <p className="text-xs text-stone-500">æƒæ QR Code æˆ–è¤‡è£½ä¸‹æ–¹é€£çµ<br/>èˆ‡æœ‹å‹åˆ†äº«é€™å€‹å¥½ç”¨çš„å°å·¥å…·ï¼</p>
                            <div className="flex items-center gap-2 bg-stone-50 p-2 rounded-lg border border-stone-100">
                                <input readOnly value={window.location.href} className="bg-transparent text-xs text-stone-500 w-full outline-none truncate" />
                                <button onClick={() => {navigator.clipboard.writeText(window.location.href); alert("ç¶²å€å·²è¤‡è£½ï¼")}} className="text-[#E07A5F] hover:text-[#D0654B]"><LinkIcon size={16}/></button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const GuideModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-stone-900/60 backdrop-blur-sm modal-overlay">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-sm w-full max-h-[90vh] flex flex-col overflow-hidden relative">
                        <button onClick={onClose} className="absolute top-3 right-3 p-1 hover:bg-stone-100 rounded-full text-stone-400 z-10 bg-white/50"><X size={20}/></button>
                        <div className="p-4 border-b border-stone-100 bg-[#FFF9F0]">
                            <h3 className="font-bold text-stone-700 flex items-center gap-2">
                                <Download size={18} className="text-[#E07A5F]"/> åŠ å…¥æ¡Œé¢æ•™å­¸
                            </h3>
                        </div>
                        <div className="flex-1 overflow-auto p-4 bg-stone-50 text-center">
                            <img src={PROXY_GUIDE_IMG_URL} crossOrigin="anonymous" alt="åŠ å…¥æ¡Œé¢æ•™å­¸" className="w-full h-auto rounded-lg shadow-sm mb-4" />
                            <a href={PROXY_GUIDE_IMG_URL} download="åŠ å…¥æ¡Œé¢æ•™å­¸.png" className="inline-block px-4 py-2 bg-[#E07A5F] text-white text-xs font-bold rounded-full shadow-md hover:bg-[#D0654B] transition-colors">ä¸‹è¼‰æ•™å­¸åœ–ç‰‡</a>
                        </div>
                    </div>
                </div>
            );
        }

        const ReceiptModal = ({ isOpen, onClose, imgSrc }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-stone-900/60 backdrop-blur-sm modal-overlay">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-sm w-full max-h-[90vh] flex flex-col overflow-hidden">
                        <div className="p-4 border-b border-stone-100 flex justify-between items-center bg-[#FFF9F0]">
                            <h3 className="font-bold text-stone-700 flex items-center gap-2"><Receipt size={18} className="text-[#E07A5F]"/> åˆ†å¸³æ˜ç´°åœ–</h3>
                            <button onClick={onClose} className="p-1 hover:bg-stone-200 rounded-full text-stone-400"><X size={20}/></button>
                        </div>
                        <div className="flex-1 overflow-auto p-4 bg-[#F8F5F2] flex justify-center">
                            {imgSrc ? <img src={imgSrc} alt="åˆ†å¸³æ˜ç´°" className="shadow-lg rounded-lg max-w-full h-auto object-contain" /> : <div className="flex items-center justify-center h-40 text-stone-400">ç”Ÿæˆä¸­...</div>}
                        </div>
                        <div className="p-4 border-t border-stone-100 bg-white space-y-2">
                             <a href={imgSrc} download={`èšé¤åˆ†å¸³_${new Date().toISOString().slice(0,10)}.png`} className="block w-full py-3 bg-[#E07A5F] hover:bg-[#D0654B] text-white text-center font-bold rounded-xl transition-colors shadow-lg shadow-orange-100">ä¸‹è¼‰åœ–ç‰‡</a>
                            <p className="text-[10px] text-center text-stone-400">æˆ–é•·æŒ‰åœ–ç‰‡å„²å­˜åˆ†äº«</p>
                        </div>
                    </div>
                </div>
            );
        };

        const HiddenReceipt = ({ people, totals, serviceCharge, mode, date }) => (
            <div id="receipt-capture" style={{ position: 'absolute', top: '-9999px', left: '-9999px', width: '400px', backgroundColor: '#FFF9F0', padding: '30px', fontFamily: 'sans-serif', color: '#4A403A' }}>
                <div style={{ textAlign: 'center', marginBottom: '20px', borderBottom: '2px dashed #D7CCC8', paddingBottom: '20px' }}>
                    <h2 style={{ fontSize: '24px', fontWeight: 'bold', color: '#E07A5F', margin: 0 }}>åˆ†å¸³å°å¹«æ‰‹æ˜ç´°</h2>
                    <p style={{ fontSize: '12px', color: '#8D7F75', marginTop: '5px' }}>{date}</p>
                </div>
                <div style={{ marginBottom: '20px', fontSize: '14px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '5px' }}><span>é¤è²»å°è¨ˆ</span><span style={{ fontWeight: 'bold' }}>{formatCurrency(totals.subtotal)}</span></div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '5px' }}><span>æœå‹™è²» ({serviceCharge}%)</span><span style={{ fontWeight: 'bold' }}>{formatCurrency(totals.serviceFee)}</span></div>
                    {totals.discount > 0 && <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '5px', color: '#E07A5F' }}><span>æŠ˜æ‰£</span><span style={{ fontWeight: 'bold' }}>-{formatCurrency(totals.discount)}</span></div>}
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '10px', paddingTop: '10px', borderTop: '1px solid #D7CCC8', fontSize: '18px', fontWeight: 'bold', color: '#E07A5F' }}><span>ç¸½é‡‘é¡</span><span>{formatCurrency(totals.grandTotal)}</span></div>
                </div>
                <div style={{ borderTop: '2px dashed #D7CCC8', paddingTop: '20px', marginBottom: '20px' }}>
                    <h3 style={{ fontSize: '14px', fontWeight: 'bold', marginBottom: '10px', color: '#8D7F75' }}>åˆ†æ”¤åå–® ({people.length}äºº)</h3>
                    {people.map((p, i) => (
                        <div key={i} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px', paddingBottom: '8px', borderBottom: '1px solid #EFE6E0' }}>
                            <div><div style={{ fontWeight: 'bold', fontSize: '16px' }}>{p.name || `æœ‹å‹ ${i+1}`}</div><div style={{ fontSize: '10px', color: '#8D7F75' }}>{mode === MODES.SEPARATE ? `(å€‹$${p.personalAmount} + å…¬$${Math.round(p.breakdown.shared)})` : 'å¹³å‡åˆ†æ”¤'}{p.weight !== 1 && ` â€¢ ${p.weight}ä»½`}</div></div>
                            <div style={{ fontSize: '18px', fontWeight: 'bold', color: '#4A403A' }}>{formatCurrency(p.finalPay)}</div>
                        </div>
                    ))}
                </div>
                <div style={{ textAlign: 'center', borderTop: '1px solid #EFE6E0', paddingTop: '20px' }}>
                    <img src={PROXY_QR_CODE_URL} crossOrigin="anonymous" style={{ width: '80px', height: '80px', margin: '0 auto 10px', mixBlendMode: 'multiply' }} />
                    <div style={{ fontSize: '10px', color: '#D7CCC8' }}>Generated by åˆ†å¸³å°å¹«æ‰‹</div>
                </div>
            </div>
        );

        // --- Main App ---

        function SplitBillApp() {
            const [people, setPeople] = useState([{ id: 1, name: '', personalAmount: 0, weight: 1 }, { id: 2, name: '', personalAmount: 0, weight: 1 }]);
            const [sharedBill, setSharedBill] = useState('');
            const [takeoutBill, setTakeoutBill] = useState('');
            const [serviceCharge, setServiceCharge] = useState(DEFAULT_SERVICE_CHARGE);
            const [mode, setMode] = useState(MODES.SPLIT_ALL);
            const [discountType, setDiscountType] = useState(DISCOUNT_TYPES.NONE);
            const [discountValue, setDiscountValue] = useState('');
            const [discountTiming, setDiscountTiming] = useState(DISCOUNT_TIMING.AFTER_TAX); 

            // Modal States
            const [showReceipt, setShowReceipt] = useState(false);
            const [receiptImg, setReceiptImg] = useState('');
            const [showShare, setShowShare] = useState(false);
            const [showGuide, setShowGuide] = useState(false);

            const handleDiscountTypeChange = (newType) => { setDiscountType(newType); setDiscountValue(''); };
            const { peopleResults, totals } = useMemo(() => calculateBill(people, Number(sharedBill) || 0, Number(takeoutBill) || 0, Number(serviceCharge) || 0, mode, discountType, Number(discountValue), discountTiming), [people, sharedBill, takeoutBill, serviceCharge, mode, discountType, discountValue, discountTiming]);

            const addPerson = () => { const newId = people.length > 0 ? Math.max(...people.map(p => p.id)) + 1 : 1; setPeople([...people, { id: newId, name: '', personalAmount: 0, weight: 1 }]); };
            const removePerson = (id) => setPeople(people.filter(p => p.id !== id));
            const updatePerson = (id, field, value) => setPeople(people.map(p => p.id === id ? { ...p, [field]: value } : p));
            const toggleWeight = (id) => setPeople(people.map(p => p.id === id ? { ...p, weight: p.weight === 1 ? 0.5 : 1 } : p));
            const toggleMode = () => setMode(prev => prev === MODES.SPLIT_ALL ? MODES.SEPARATE : MODES.SPLIT_ALL);
            
            const generateReceipt = async () => {
                const element = document.getElementById('receipt-capture');
                if (!element) return;
                try {
                    const canvas = await html2canvas(element, { scale: 2, useCORS: true, backgroundColor: '#FFF9F0' });
                    setReceiptImg(canvas.toDataURL('image/png'));
                    setShowReceipt(true);
                } catch (error) { console.error('Screenshot failed:', error); alert('ç”Ÿæˆåœ–ç‰‡å¤±æ•—ï¼Œè«‹é‡è©¦'); }
            };

            return (
                <div className="min-h-screen font-sans p-3 md:p-6 w-full overflow-x-hidden">
                    <div className="max-w-4xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-3 w-full">
                        <div className="lg:col-span-12 mb-1 lg:mb-2">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                    <div className="w-10 h-10 rounded-lg shadow-md shadow-orange-200 overflow-hidden shrink-0">
                                        <img src={PROXY_LOGO_URL} alt="Logo" className="w-full h-full object-cover" />
                                    </div>
                                    <div><h1 className="text-xl font-bold text-[#4A403A] tracking-tight leading-tight">åˆ†å¸³å°å¹«æ‰‹</h1><p className="text-[10px] text-stone-500 font-medium">v2.1.2</p></div>
                                </div>
                                <div className="flex gap-2">
                                    <HeaderButton icon={Camera} onClick={generateReceipt} label="ç”Ÿæˆåœ–ç‰‡" />
                                    <HeaderButton icon={Share2} onClick={() => setShowShare(true)} label="åˆ†äº«é€£çµ" />
                                    <HeaderButton icon={Download} onClick={() => setShowGuide(true)} label="åŠ å…¥æ¡Œé¢" />
                                </div>
                            </div>
                        </div>

                        <div className="lg:col-span-5 space-y-3 w-full">
                            <Card>
                                <div className="flex items-center gap-2 mb-3 text-[#E07A5F] font-bold text-base"><Settings size={18} /><h3>è¨ˆç®—è¨­å®š</h3></div>
                                <div className="space-y-3">
                                    <div><label className="block text-xs font-bold text-stone-600 mb-1">åˆ†å¸³æ¨¡å¼</label><ToggleSwitch active={mode === MODES.SPLIT_ALL ? 'left' : 'right'} onClick={toggleMode} leftLabel="å…¨éƒ¨å¹³åˆ†" rightLabel="æ‰£é™¤å„åˆ¥å–®é»" /></div>
                                    <div className="grid grid-cols-2 gap-3"><InputGroup label="æœå‹™è²»ç‡" icon={Receipt} value={serviceCharge} onChange={(e) => setServiceCharge(e.target.value)} subLabel="%" /><InputGroup label="å¤–å¸¶(å…æœå‹™è²»)" icon={Coffee} value={takeoutBill} onChange={(e) => setTakeoutBill(e.target.value)} placeholder="0" /></div>
                                </div>
                            </Card>
                            <Card className="border-l-4 border-l-[#E07A5F]">
                                <div className="flex items-center gap-2 mb-3 text-[#E07A5F] font-bold text-base"><DollarSign size={18} /><h3>{mode === MODES.SPLIT_ALL ? 'ç¸½é‡‘é¡ (æœªç¨…)' : 'å…±åŒåˆ†é£Ÿ (æœªç¨…)'}</h3></div>
                                <InputGroup label={mode === MODES.SPLIT_ALL ? "å¸³å–®ç¸½é‡‘é¡" : "å¤§å®¶ä¸€èµ·åƒçš„é‡‘é¡"} value={sharedBill} onChange={(e) => setSharedBill(e.target.value)} placeholder="è¼¸å…¥é‡‘é¡" className="text-lg font-bold text-[#E07A5F]" />
                                <p className="mt-2 mb-4 text-[10px] text-stone-500 font-medium bg-[#FFF9F0] p-2 rounded border border-[#E6D5C8] leading-tight">{mode === MODES.SPLIT_ALL ? "å«æœå‹™è²»å¾Œå¹³å‡åˆ†é…ã€‚" : "åŠ æ”¶æœå‹™è²»å¾Œåˆ†é…ã€‚å€‹äººéƒ¨åˆ†è«‹åœ¨å³å´è¼¸å…¥ã€‚"}</p>
                                <DiscountSelector type={discountType} onChangeType={handleDiscountTypeChange} value={discountValue} onChangeValue={(e) => setDiscountValue(e.target.value)} timing={discountTiming} onChangeTiming={setDiscountTiming} />
                            </Card>
                            <Card className="!bg-[#3D405B] text-white border-none shadow-xl shadow-stone-300 hidden lg:block">
                                <div className="space-y-3">
                                    <div className="flex justify-between items-end border-b border-white/20 pb-3"><span className="text-white/80 font-medium text-sm">ç¸½é‡‘é¡ (å«è²»)</span><span className="text-3xl font-bold tracking-tight text-white">{formatCurrency(totals.grandTotal)}</span></div>
                                    <div className="grid grid-cols-2 gap-4 text-xs text-white/80"><div><span className="block opacity-60 mb-0.5">é¤è²»å°è¨ˆ</span><span className="font-semibold text-white text-base">{formatCurrency(totals.subtotal)}</span></div><div><span className="block opacity-60 mb-0.5">æœå‹™è²»ç¸½è¨ˆ</span><span className="font-semibold text-white text-base">{formatCurrency(totals.serviceFee)}</span></div></div>
                                    {totals.discount > 0 && <div className="pt-2 border-t border-white/20 text-xs text-[#E07A5F] flex justify-between"><span>å·²æ‰£é™¤æŠ˜æ‰£</span><span>-{formatCurrency(totals.discount)}</span></div>}
                                </div>
                            </Card>
                        </div>

                        <div className="lg:col-span-7 space-y-3 w-full">
                            <Card className="flex flex-col h-auto">
                                <div className="flex justify-between items-center mb-4"><div className="flex items-center gap-2 text-[#E07A5F] font-bold text-base"><User size={18} /><h3>åå–® ({people.length}äºº)</h3></div><button onClick={addPerson} className="flex items-center gap-1 bg-[#FFF0E6] hover:bg-[#FFE0CC] text-[#E07A5F] px-2.5 py-1 rounded-md text-xs font-bold transition-colors"><Plus size={14} /> å¢åŠ </button></div>
                                <div className="space-y-2">
                                    {people.map((person, index) => (
                                        <div key={person.id} className="group flex flex-col sm:flex-row items-center gap-2 p-2 rounded-lg hover:bg-[#FFF9F0] border border-transparent hover:border-[#E6D5C8] transition-all bg-white/50 sm:bg-transparent">
                                            <div className="flex items-center gap-2 w-full sm:w-auto flex-1">
                                                <button onClick={() => removePerson(person.id)} className="text-stone-300 hover:text-red-500 transition-colors p-1" title="ç§»é™¤"><Trash2 size={16} /></button>
                                                <div className="flex-1 flex items-center gap-2">
                                                    <div className={`w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold shrink-0 ${getAvatarStyle(index)}`}>{index + 1}</div>
                                                    <div className="relative flex-1"><input type="text" value={person.name} onChange={(e) => updatePerson(person.id, 'name', e.target.value)} className="w-full bg-[#FFFCF9] border border-[#E6D5C8] focus:border-[#E07A5F] rounded-md px-3 py-1.5 text-stone-800 font-bold text-sm outline-none shadow-sm placeholder-stone-300 transition-all" placeholder={`è¼¸å…¥å§“å`} /></div>
                                                    <button onClick={() => toggleWeight(person.id)} className={`shrink-0 px-2 py-1.5 rounded-md text-xs font-bold border transition-all w-12 text-center ${person.weight === 1 ? 'bg-[#F2F2F2] text-stone-500 border-[#D7CCC8] hover:bg-[#E6E6E6]' : 'bg-[#FFE0CC] text-[#E07A5F] border-[#FFCCBC] ring-1 ring-orange-100'}`} title="é»æ“Šåˆ‡æ›ä»½é‡">x{person.weight}</button>
                                                </div>
                                            </div>
                                            {mode === MODES.SEPARATE && <div className="w-full sm:w-28 pl-8 sm:pl-0"><div className="relative"><span className="absolute left-2 top-1/2 -translate-y-1/2 text-stone-400 text-[10px] font-bold">$</span><input type="number" placeholder="å€‹äºº" value={person.personalAmount || ''} onChange={(e) => updatePerson(person.id, 'personalAmount', e.target.value)} className="w-full pl-5 pr-2 py-1.5 text-sm bg-[#FFFCF9] border border-[#E6D5C8] rounded-md focus:ring-2 focus:ring-[#E07A5F] outline-none text-right font-medium text-stone-700" /></div></div>}
                                            <div className="w-full sm:w-auto sm:min-w-[100px] text-right flex justify-between sm:block items-center pl-8 sm:pl-0"><span className="text-xs text-stone-500 font-bold sm:hidden">æ‡‰ä»˜</span><div><span className="text-base font-bold text-[#E07A5F] block leading-tight">{formatCurrency(peopleResults.find(p => p.id === person.id)?.finalPay || 0)}</span>{mode === MODES.SEPARATE && <div className="text-[9px] text-stone-400 font-medium hidden sm:block">(å…±é£Ÿ+{Math.round(peopleResults.find(p => p.id === person.id)?.breakdown.shared || 0)})</div>}</div></div>
                                        </div>
                                    ))}
                                    {people.length === 0 && <div className="text-center py-8 text-stone-400"><User size={32} className="mx-auto mb-2 opacity-20" /><p className="text-xs">é»æ“Šã€Œå¢åŠ ã€é–‹å§‹åˆ†å¸³</p></div>}
                                </div>
                                <div className="mt-6 pt-4 border-t border-[#E6D5C8]"><h4 className="text-sm font-bold text-[#E07A5F] mb-2 flex items-center gap-1"><span className="text-lg">ğŸ’¡</span> å°å¹«æ‰‹ç‰¹é»</h4><ul className="text-xs text-stone-500 space-y-1 pl-1"><li className="flex items-start gap-1.5"><span className="mt-0.5 w-1 h-1 rounded-full bg-[#E07A5F] shrink-0"></span><span><span className="font-bold text-stone-600">å½ˆæ€§æ¨¡å¼</span>ï¼šéš¨æ„åˆ‡æ›ã€Œå…¨é«”å¹³åˆ†ã€æˆ–ã€Œå„ä»˜å„çš„ã€ã€‚</span></li><li className="flex items-start gap-1.5"><span className="mt-0.5 w-1 h-1 rounded-full bg-[#E07A5F] shrink-0"></span><span><span className="font-bold text-stone-600">æ™ºæ…§æŠ˜æ‰£</span>ï¼šæ”¯æ´æœå‹™è²»å‰/å¾Œæ‰£æŠµï¼Œç²¾æº–è¨ˆç®—ä¸åƒè™§ã€‚</span></li><li className="flex items-start gap-1.5"><span className="mt-0.5 w-1 h-1 rounded-full bg-[#E07A5F] shrink-0"></span><span><span className="font-bold text-stone-600">ä»½é‡æ¬Šé‡</span>ï¼šé»æ“ŠæŒ‰éˆ•åˆ‡æ› x1 (æ­£å¸¸) æˆ– x0.5 (å°å­©)ã€‚</span></li><li className="flex items-start gap-1.5"><span className="mt-0.5 w-1 h-1 rounded-full bg-[#E07A5F] shrink-0"></span><span><span className="font-bold text-stone-600">æ˜ç´°å­˜åœ–</span>ï¼šå³ä¸Šè§’ç›¸æ©ŸæŒ‰éˆ•ï¼Œä¸€éµç”Ÿæˆç¾è§€å¸³å–®åˆ†äº«ã€‚</span></li><li className="flex items-start gap-1.5"><span className="mt-0.5 w-1 h-1 rounded-full bg-[#E07A5F] shrink-0"></span><span><span className="font-bold text-stone-600">åŠ å…¥æ¡Œé¢</span>ï¼šéš±è—ç¶²å€åˆ—ï¼Œäº«å—å…¨è¢å¹• App é«”é©—ã€‚</span></li></ul></div>
                            </Card>
                            <Card className="!bg-[#3D405B] text-white border-none shadow-xl shadow-stone-300 lg:hidden mt-2">
                                <div className="flex justify-between items-center"><div><span className="block text-white/80 text-xs font-medium">ç¸½é‡‘é¡ (å«è²»)</span><span className="text-2xl font-bold text-white">{formatCurrency(totals.grandTotal)}</span></div><div className="text-right text-xs text-white/80 font-medium"><div>æœå‹™è²»: {formatCurrency(totals.serviceFee)}</div>{totals.discount > 0 && <div className="text-[#E07A5F]">æŠ˜æ‰£: -{formatCurrency(totals.discount)}</div>}</div></div>
                            </Card>
                        </div>
                    </div>

                    <HiddenReceipt people={peopleResults} totals={totals} serviceCharge={serviceCharge} mode={mode} date={formatDate()} />
                    <ReceiptModal isOpen={showReceipt} onClose={() => setShowReceipt(false)} imgSrc={receiptImg} />
                    <ShareModal isOpen={showShare} onClose={() => setShowShare(false)} />
                    <GuideModal isOpen={showGuide} onClose={() => setShowGuide(false)} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SplitBillApp />);
    </script>
</body>
</html>
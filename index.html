<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>分帳小幫手 v2.3.6</title>
    
    <!-- 強制瀏覽器不快取 HTML -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- 預先連線加速 CDN -->
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">

    <!-- PWA 設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="分帳小幫手">

    <!-- 設定 App Icon -->
    <link rel="icon" href="https://wsrv.nl/?url=https%3A%2F%2Fdrive.google.com%2Fuc%3Fexport%3Dview%26id%3D1dhOMUAE1lZ2faIDdyd7jtJZbZf-f1C6u&w=192&output=png" type="image/png">
    <link rel="apple-touch-icon" href="https://wsrv.nl/?url=https%3A%2F%2Fdrive.google.com%2Fuc%3Fexport%3Dview%26id%3D1dhOMUAE1lZ2faIDdyd7jtJZbZf-f1C6u&w=180&output=png">
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 引入 React 與 Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 移除了一開始就載入 html2canvas，改為按需載入以加速啟動 -->

    <style>
        html, body { overflow-x: hidden; width: 100%; }
        input { font-size: 16px !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #f2cc8f; border-radius: 20px; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes modalFade {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-overlay {
            animation: modalFade 0.2s ease-out forwards;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-[#FFF9F0] text-[#4A403A]">
    <!-- 
        創作者: dandy
        IG:dandy0906
    -->
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useRef, useEffect } = React;

        /**
         * 版本: v2.3.6
         * 專案: 分帳小幫手 (Performance Optimization)
         * 修改重點:
         * 1. 效能優化：移除 index.html 初始載入的 html2canvas 腳本。
         * 2. 改為「按需載入 (Lazy Load)」：只有在使用者點擊「生成圖片」按鈕時，才動態下載 html2canvas。
         * 3. 這可以減少初始下載量，稍微提升網頁開啟速度。
         */

        const CURRENT_VERSION = "v2.3.6";

        // --- Assets ---
        const LOGO_URL = "https://drive.google.com/uc?export=view&id=1dhOMUAE1lZ2faIDdyd7jtJZbZf-f1C6u";
        const PROXY_LOGO_URL = `https://wsrv.nl/?url=${encodeURIComponent(LOGO_URL)}&w=100&output=png`;

        const QR_CODE_URL = "https://drive.google.com/uc?export=view&id=1_gZxk_FmAJez9E_bvr2OeytzG1du5rvA";
        const PROXY_QR_CODE_URL = `https://wsrv.nl/?url=${encodeURIComponent(QR_CODE_URL)}&w=300&output=png`;
        
        const GUIDE_IMG_URL = "https://drive.google.com/uc?export=view&id=1c_xatKsfeRrbY51LTT5XAdkiXY9j5QyW";
        const PROXY_GUIDE_IMG_URL = `https://wsrv.nl/?url=${encodeURIComponent(GUIDE_IMG_URL)}`;

        // --- Hooks: Auto Update Checker ---
        const useCheckUpdate = () => {
            const [newVersion, setNewVersion] = useState(null);

            useEffect(() => {
                const checkUpdate = async () => {
                    try {
                        const response = await fetch(`./index.html?t=${new Date().getTime()}`);
                        const text = await response.text();
                        const match = text.match(/const CURRENT_VERSION = "(v\d+\.\d+\.\d+)";/);
                        if (match && match[1] !== CURRENT_VERSION) {
                            setNewVersion(match[1]);
                        }
                    } catch (e) {
                        console.log("Check update failed", e);
                    }
                };
                const timer = setTimeout(checkUpdate, 2000);
                return () => clearTimeout(timer);
            }, []);
            return newVersion;
        };

        // --- Helper: Universal Image Share/Download Logic ---
        const handleDownloadImage = async (imgUrl, fileName) => {
            try {
                const response = await fetch(imgUrl);
                const blob = await response.blob();
                const file = new File([blob], fileName, { type: blob.type });

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: '分帳小幫手圖片',
                            text: '這是您的分帳圖片！'
                        });
                        return;
                    } catch (shareError) {
                        console.log('Share API cancelled or failed, falling back to download', shareError);
                    }
                }

                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

            } catch (error) {
                console.error("Download/Share failed:", error);
                alert("無法自動開啟分享選單。請直接長按圖片進行儲存。");
            }
        };

        // --- Helper: Lazy Load Script ---
        const loadScript = (src) => {
            return new Promise((resolve, reject) => {
                if (document.querySelector(`script[src="${src}"]`)) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        };

        // --- Icon Components ---
        const IconBase = ({ children, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Plus = (props) => <IconBase {...props}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></IconBase>;
        const User = (props) => <IconBase {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></IconBase>;
        const Receipt = (props) => <IconBase {...props}><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1-2-1Z"></path><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"></path><path d="M12 17V7"></path></IconBase>;
        const DollarSign = (props) => <IconBase {...props}><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></IconBase>;
        const Coffee = (props) => <IconBase {...props}><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></IconBase>;
        const Share2 = (props) => <IconBase {...props}><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></IconBase>;
        const Tag = (props) => <IconBase {...props}><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></IconBase>;
        const Settings = (props) => <IconBase {...props}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></IconBase>;
        const Circle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"></circle></IconBase>;
        const Camera = (props) => <IconBase {...props}><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></IconBase>;
        const X = (props) => <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></IconBase>;
        const LinkIcon = (props) => <IconBase {...props}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></IconBase>;
        const RefreshCw = (props) => <IconBase {...props}><path d="M21 2v6h-6"></path><path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path><path d="M3 22v-6h6"></path><path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path></IconBase>;
        const Star = (props) => <IconBase {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></IconBase>;
        const CheckSquare = (props) => <IconBase {...props}><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></IconBase>;
        const Square = (props) => <IconBase {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></IconBase>;

        // --- Constants & Enums ---
        const MODES = { SPLIT_ALL: 'SPLIT_ALL', SEPARATE: 'SEPARATE' };
        const DISCOUNT_TYPES = { NONE: 'NONE', PERCENT: 'PERCENT', AMOUNT: 'AMOUNT' };
        const DISCOUNT_TIMING = { BEFORE_TAX: 'BEFORE_TAX', AFTER_TAX: 'AFTER_TAX' };
        const DEFAULT_SERVICE_CHARGE = 10;

        // --- Logic ---
        const formatCurrency = (amount) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
        const formatDate = () => { const d = new Date(); return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }

        const getAvatarStyle = (index) => {
            const styles = ['bg-rose-100 text-rose-600', 'bg-teal-100 text-teal-600', 'bg-amber-100 text-amber-600', 'bg-sky-100 text-sky-600'];
            return styles[index % styles.length];
        };

        const calculateBill = (people, sharedAmount, takeoutAmount, extraChargeAmount, extraChargePayers, serviceChargeRate, mode, discountType, discountValue, discountTiming) => {
            const count = people.length;
            const totalWeight = people.reduce((acc, p) => acc + (p.weight || 1), 0);

            if (totalWeight === 0) return { peopleResults: [], totals: { subtotal: 0, serviceFee: 0, grandTotal: 0 } };

            const taxMultiplier = 1 + (serviceChargeRate / 100);

            // 1. 計算所有人的個人單點總額 (需先算出才能正確計算全單折扣)
            let totalIndividualBase = 0;
            if (mode === MODES.SEPARATE) {
                totalIndividualBase = people.reduce((sum, p) => sum + (parseFloat(p.personalAmount) || 0), 0);
            }

            // 2. 主帳單折扣計算 (範圍：共同金額 + 個人單點總和)
            // 這是整桌的「可打折基礎金額」
            const mainTaxableBase = sharedAmount + totalIndividualBase;
            
            let mainBillWithTax = 0; // 含稅後、折扣前
            let mainBillFinal = 0;   // 含稅後、折扣後 (要分配給大家的總額)
            let discountAmount = 0;
            let mainServiceFee = 0;

            const rawServiceFee = mainTaxableBase * (serviceChargeRate / 100);
            const rawTotalWithTax = mainTaxableBase * taxMultiplier;

            if (discountType === DISCOUNT_TYPES.AMOUNT) {
                const amount = discountValue || 0;
                if (discountTiming === DISCOUNT_TIMING.BEFORE_TAX) {
                    // 服務費前扣抵: (總金額 - 折扣) * 1.1
                    const adjustedBase = Math.max(0, mainTaxableBase - amount);
                    mainServiceFee = adjustedBase * (serviceChargeRate / 100);
                    mainBillFinal = adjustedBase * taxMultiplier;
                    // 實際省下的錢 = 原本總額 - 折扣後總額
                    discountAmount = rawTotalWithTax - mainBillFinal;
                } else {
                    // 服務費後扣抵: (總金額 * 1.1) - 折扣
                    mainServiceFee = rawServiceFee;
                    mainBillFinal = Math.max(0, rawTotalWithTax - amount);
                    discountAmount = rawTotalWithTax - mainBillFinal;
                }
            } else if (discountType === DISCOUNT_TYPES.PERCENT) {
                const percentOff = discountValue || 0;
                const validPercentOff = Math.min(100, Math.max(0, percentOff));
                const percentMultiplier = (100 - validPercentOff) / 100;
                
                // 打折 (%) 通常是對「含稅總額」打折，或是「餐費打折+原價服務費」
                // 依據需求：服務費依原價計算。公式：(總金額 + 10%服務費) - 折扣
                mainServiceFee = rawServiceFee;
                mainBillFinal = rawTotalWithTax * percentMultiplier;
                discountAmount = rawTotalWithTax - mainBillFinal;
            } else {
                mainServiceFee = rawServiceFee;
                mainBillFinal = rawTotalWithTax;
                discountAmount = 0;
            }

            // 3. 額外加點計算 (獨立計算，不參與主帳單折扣)
            // 只有當有人分攤時，才計算這筆錢
            const extraPayersCount = extraChargePayers.length;
            const hasExtraPayers = extraPayersCount > 0;
            
            const extraChargeWithTax = hasExtraPayers ? extraChargeAmount * taxMultiplier : 0;
            const extraChargeFee = hasExtraPayers ? extraChargeAmount * (serviceChargeRate / 100) : 0;
            const extraPerPerson = hasExtraPayers ? extraChargeWithTax / extraPayersCount : 0;

            // 4. 分配金額 (Distribute)
            const takeoutPerPerson = takeoutAmount / count;

            const peopleResults = people.map(person => {
                const weight = person.weight || 1;
                const personalBase = (mode === MODES.SEPARATE) ? (parseFloat(person.personalAmount) || 0) : 0;
                
                // 計算「原始應付金額 (未折扣)」
                // 該員的共同分食佔比 = (共同金額 / 總權重 * 個人權重)
                const mySharedRaw = (sharedAmount / totalWeight * weight) * taxMultiplier;
                // 該員的個人單點 (含稅)
                const myPersonalRaw = personalBase * taxMultiplier;
                
                const myTotalRaw = mySharedRaw + myPersonalRaw;

                // 依比例分配折扣後的總金額
                // 邏輯：該員應付 = 折扣後總額 * (該員原始應付 / 原始總額)
                let myFinalMain = 0;
                let myAdjustedShared = mySharedRaw;
                let myAdjustedPersonal = myPersonalRaw;

                if (rawTotalWithTax > 0) {
                    const ratio = mainBillFinal / rawTotalWithTax;
                    myFinalMain = myTotalRaw * ratio;
                    // 用同樣比例調整細項顯示 (僅供參考用)
                    myAdjustedShared = mySharedRaw * ratio;
                    myAdjustedPersonal = myPersonalRaw * ratio;
                }

                // 計算每個人分配到的折扣金額 (原始應付 - 實際應付)
                const myDiscount = myTotalRaw - myFinalMain;

                // 額外加點
                const myExtra = extraChargePayers.includes(person.id) ? extraPerPerson : 0;
                
                const finalPay = myFinalMain + myExtra + takeoutPerPerson;

                return {
                    ...person,
                    breakdown: {
                        shared: myAdjustedShared,
                        personal: myAdjustedPersonal,
                        takeout: takeoutPerPerson,
                        extra: myExtra,
                        discount: myDiscount // 新增折扣金額到 breakdown
                    },
                    finalPay: Math.round(finalPay)
                };
            });

            // 5. 總結計算
            // 為了讓總結數字與每個人加總一致，這裡使用 peopleResults 的加總
            const grandTotal = peopleResults.reduce((acc, p) => acc + p.finalPay, 0);
            
            // 顯示用的統計數據 (僅當有選人分攤時，才把額外加點算進 Subtotal)
            const validExtraCharge = hasExtraPayers ? parseFloat(extraChargeAmount) : 0;
            const totalSubtotal = sharedAmount + totalIndividualBase + takeoutAmount + validExtraCharge;
            const totalServiceFee = mainServiceFee + extraChargeFee;

            return {
                peopleResults,
                totals: {
                    subtotal: totalSubtotal,
                    serviceFee: totalServiceFee,
                    grandTotal: grandTotal,
                    discount: discountAmount
                }
            };
        };

        // --- UI Components ---

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white/90 backdrop-blur-md rounded-2xl shadow-sm border border-[#E6D5C8] p-4 w-full ${className}`}>
                {children}
            </div>
        );

        const InputGroup = ({ label, icon: Icon, value, onChange, placeholder, type = "number", subLabel, className = "" }) => (
            <div className="flex flex-col space-y-1">
                <label className="text-sm font-bold text-stone-600 flex justify-between items-center">
                    <span className="flex items-center gap-1.5 whitespace-nowrap">{Icon && <Icon size={14} className="text-[#E07A5F]" />}{label}</span>
                    {subLabel && <span className="text-[10px] text-stone-400 font-medium">{subLabel}</span>}
                </label>
                <input type={type} value={value} onChange={onChange} placeholder={placeholder} onFocus={(e) => e.target.select()} className={`w-full px-3 py-2 bg-[#FFFCF9] border border-[#E6D5C8] rounded-lg focus:ring-2 focus:ring-[#E07A5F] focus:border-[#E07A5F] outline-none transition-all text-stone-800 font-bold placeholder-stone-300 shadow-inner text-sm ${className}`} />
            </div>
        );

        const ToggleSwitch = ({ active, onClick, leftLabel, rightLabel }) => (
            <div className="flex bg-[#EFE6E0] p-1 rounded-lg relative cursor-pointer shadow-inner select-none" onClick={onClick}>
                <div className={`absolute top-1 bottom-1 w-[calc(50%-4px)] bg-white rounded-md shadow-sm transition-all duration-300 ease-out border border-[#D7CCC8] ${active === 'left' ? 'left-1' : 'left-[calc(50%+2px)]'}`} />
                <div className={`flex-1 z-10 text-center py-1.5 text-xs font-bold transition-colors ${active === 'left' ? 'text-[#E07A5F]' : 'text-stone-400'}`}>{leftLabel}</div>
                <div className={`flex-1 z-10 text-center py-1.5 text-xs font-bold transition-colors ${active === 'right' ? 'text-[#E07A5F]' : 'text-stone-400'}`}>{rightLabel}</div>
            </div>
        );

        const RadioOption = ({ selected, onClick, label }) => (
            <div onClick={onClick} className={`flex items-center gap-1 cursor-pointer transition-colors ${selected ? 'text-[#E07A5F] font-bold' : 'text-stone-400 hover:text-stone-600'}`}>
                {selected ? <CheckCircle size={14} /> : <Circle size={14} />}<span className="text-xs">{label}</span>
            </div>
        );

        const ExtraChargeModule = ({ name, onNameChange, amount, onAmountChange, people, selectedIds, onTogglePerson }) => {
            return (
                <div className="space-y-2 pt-2 border-t border-[#E6D5C8] pb-2">
                    <div className="flex items-center gap-2 mb-1">
                         <Star size={16} className="text-[#E07A5F]" />
                         <span className="text-sm font-bold text-stone-600">額外加點</span>
                    </div>
                    
                    <div className="flex flex-col gap-2">
                        <input
                            type="text"
                            value={name}
                            onChange={onNameChange}
                            placeholder="品項名稱 (例如: 酒水)"
                            className="w-full px-3 py-2 bg-[#FFFCF9] border border-[#E6D5C8] rounded-lg focus:ring-2 focus:ring-[#E07A5F] outline-none text-stone-800 font-bold text-sm shadow-inner"
                        />
                        <input
                            type="number"
                            value={amount}
                            onChange={onAmountChange}
                            placeholder="輸入金額"
                            className="w-full px-3 py-2 bg-[#FFFCF9] border border-[#E6D5C8] rounded-lg focus:ring-2 focus:ring-[#E07A5F] outline-none text-stone-800 font-bold text-sm shadow-inner"
                        />
                    </div>
                    <p className="text-[10px] text-stone-400 leading-tight">
                        適用在某些人額外負擔某些品項，例如：個人加點(或外帶)、某幾位分攤酒錢...等等. 請在下方勾選分攤人員
                    </p>

                    <div className="bg-[#FFF9F0] p-2 rounded-lg border border-[#E6D5C8] max-h-32 overflow-y-auto custom-scrollbar">
                        <div className="flex flex-wrap gap-2">
                            {people.map(p => {
                                const isSelected = selectedIds.includes(p.id);
                                return (
                                    <button
                                        key={p.id}
                                        onClick={() => onTogglePerson(p.id)}
                                        className={`flex items-center gap-1 px-2 py-1 rounded-md text-[10px] font-bold border transition-all ${
                                            isSelected 
                                            ? 'bg-[#E07A5F] text-white border-[#E07A5F]' 
                                            : 'bg-white text-stone-400 border-stone-200 hover:border-stone-300'
                                        }`}
                                    >
                                        {isSelected ? <CheckSquare size={12}/> : <Square size={12}/>}
                                        {p.name || `朋友 ${p.id}`}
                                    </button>
                                );
                            })}
                            {people.length === 0 && <span className="text-[10px] text-stone-400">請先新增名單</span>}
                        </div>
                    </div>
                </div>
            );
        };

        const DiscountSelector = ({ type, onChangeType, value, onChangeValue, timing, onChangeTiming }) => {
            const discountLabel = useMemo(() => {
                if (!value || type !== DISCOUNT_TYPES.PERCENT) return '';
                const percentOff = parseFloat(value);
                const discountRate = (100 - percentOff) / 10;
                return discountRate % 1 === 0 ? `${discountRate}折` : `${discountRate}折`;
            }, [value, type]);

            return (
                <div className="space-y-2 pt-2 border-t border-[#E6D5C8]">
                    <div className="flex items-center gap-2 mb-1"><Tag size={16} className="text-[#E07A5F]" /><span className="text-sm font-bold text-stone-600">折扣設定</span></div>
                    <div className="flex bg-[#EFE6E0] p-1 rounded-lg">
                        {[ { id: DISCOUNT_TYPES.NONE, label: '無折扣' }, { id: DISCOUNT_TYPES.PERCENT, label: '打折 (%)' }, { id: DISCOUNT_TYPES.AMOUNT, label: '扣抵 (元)' } ].map(opt => (
                            <button key={opt.id} onClick={() => onChangeType(opt.id)} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${type === opt.id ? 'bg-white text-[#E07A5F] shadow-sm border border-[#D7CCC8]' : 'text-stone-400 hover:text-stone-600'}`}>{opt.label}</button>
                        ))}
                    </div>
                    {type !== DISCOUNT_TYPES.NONE && (
                        <div className="animate-fade-in space-y-2">
                            <div className="flex items-center gap-2">
                                <input type="number" value={value} onChange={onChangeValue} placeholder={type === DISCOUNT_TYPES.PERCENT ? "例如: 10 (代表9折)" : "輸入扣除金額"} className="flex-1 px-3 py-2 bg-[#FFFCF9] border border-orange-200 rounded-lg focus:ring-2 focus:ring-[#E07A5F] outline-none text-orange-700 font-bold text-sm shadow-inner" />
                                {type === DISCOUNT_TYPES.PERCENT && discountLabel && <span className="text-sm font-bold text-stone-400 whitespace-nowrap">{discountLabel}</span>}
                                {type === DISCOUNT_TYPES.AMOUNT && <span className="text-sm font-bold text-stone-400 whitespace-nowrap">元</span>}
                            </div>
                            {type === DISCOUNT_TYPES.PERCENT && <div className="text-[10px] text-stone-500 bg-[#FFF9F0] p-2 rounded border border-[#E6D5C8] leading-relaxed"><span className="font-bold text-stone-600">計算邏輯：</span>針對台灣常見習慣，服務費依「原價」計算。公式為：(總金額 + 10%服務費) - 折扣 = 應付總額。若是「打折(%)」，則是針對總金額打折。</div>}
                            {type === DISCOUNT_TYPES.AMOUNT && <div className="flex gap-4 px-1 py-1"><RadioOption selected={timing === DISCOUNT_TIMING.BEFORE_TAX} onClick={() => onChangeTiming(DISCOUNT_TIMING.BEFORE_TAX)} label="服務費前扣抵" /><RadioOption selected={timing === DISCOUNT_TIMING.AFTER_TAX} onClick={() => onChangeTiming(DISCOUNT_TIMING.AFTER_TAX)} label="服務費後扣抵" /></div>}
                        </div>
                    )}
                </div>
            );
        };

        const HeaderButton = ({ icon: Icon, onClick, label }) => (
            <button 
                onClick={onClick}
                className="flex flex-col items-center justify-center gap-1 group"
                title={label}
            >
                <div className="p-2 bg-white/60 group-hover:bg-white text-[#E07A5F] rounded-lg transition-colors border border-[#E6D5C8] shadow-sm">
                    <Icon size={20} />
                </div>
                <span className="text-[9px] font-bold text-[#E07A5F] opacity-80 group-hover:opacity-100 transition-opacity">{label}</span>
            </button>
        );

        // --- Modals ---

        const ShareModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-stone-900/60 backdrop-blur-sm modal-overlay">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-xs w-full overflow-hidden flex flex-col relative">
                        <button onClick={onClose} className="absolute top-3 right-3 p-1 hover:bg-stone-100 rounded-full text-stone-400 z-10"><X size={20}/></button>
                        <div className="p-6 text-center space-y-4">
                            <h3 className="font-bold text-stone-700 text-lg flex items-center justify-center gap-2">
                                <Share2 size={20} className="text-[#E07A5F]"/> 分享小幫手
                            </h3>
                            <div className="bg-[#FFF9F0] p-4 rounded-xl border border-[#E6D5C8] inline-block">
                                <img src={PROXY_QR_CODE_URL} crossOrigin="anonymous" alt="Scan to Share" className="w-40 h-40 object-contain mix-blend-multiply" />
                            </div>
                            <p className="text-xs text-stone-500">掃描 QR Code 或複製下方連結<br/>與朋友分享這個好用的小工具！</p>
                            <div className="flex items-center gap-2 bg-stone-50 p-2 rounded-lg border border-stone-100">
                                <input readOnly value={window.location.href} className="bg-transparent text-xs text-stone-500 w-full outline-none truncate" />
                                <button onClick={() => {navigator.clipboard.writeText(window.location.href); alert("網址已複製！")}} className="text-[#E07A5F] hover:text-[#D0654B]"><LinkIcon size={16}/></button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const GuideModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-stone-900/60 backdrop-blur-sm modal-overlay">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-sm w-full max-h-[90vh] flex flex-col overflow-hidden relative">
                        <button onClick={onClose} className="absolute top-3 right-3 p-1 hover:bg-stone-100 rounded-full text-stone-400 z-10 bg-white/50"><X size={20}/></button>
                        <div className="p-4 border-b border-stone-100 bg-[#FFF9F0]">
                            <h3 className="font-bold text-stone-700 flex items-center gap-2">
                                <Download size={18} className="text-[#E07A5F]"/> 加入桌面教學
                            </h3>
                        </div>
                        <div className="flex-1 overflow-auto p-4 bg-stone-50 text-center">
                            <img src={PROXY_GUIDE_IMG_URL} crossOrigin="anonymous" alt="加入桌面教學" className="w-full h-auto rounded-lg shadow-sm mb-4" />
                            <button 
                                onClick={() => handleDownloadImage(PROXY_GUIDE_IMG_URL, '加入桌面教學.png')}
                                className="inline-block px-4 py-2 bg-[#E07A5F] text-white text-xs font-bold rounded-full shadow-md hover:bg-[#D0654B] transition-colors"
                            >
                                分享 / 儲存圖片
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ReceiptModal = ({ isOpen, onClose, imgSrc }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-stone-900/60 backdrop-blur-sm modal-overlay">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-sm w-full max-h-[90vh] flex flex-col overflow-hidden">
                        <div className="p-4 border-b border-stone-100 flex justify-between items-center bg-[#FFF9F0]">
                            <h3 className="font-bold text-stone-700 flex items-center gap-2"><Receipt size={18} className="text-[#E07A5F]"/> 分帳明細圖</h3>
                            <button onClick={onClose} className="p-1 hover:bg-stone-200 rounded-full text-stone-400"><X size={20}/></button>
                        </div>
                        <div className="flex-1 overflow-auto p-4 bg-[#F8F5F2] flex justify-center">
                            {imgSrc ? <img src={imgSrc} alt="分帳明細" className="shadow-lg rounded-lg max-w-full h-auto object-contain" /> : <div className="flex items-center justify-center h-40 text-stone-400">生成中...</div>}
                        </div>
                        <div className="p-4 border-t border-stone-100 bg-white space-y-2">
                             <button 
                                onClick={() => handleDownloadImage(imgSrc, `聚餐分帳_${new Date().toISOString().slice(0,10)}.png`)}
                                className="block w-full py-3 bg-[#E07A5F] hover:bg-[#D0654B] text-white text-center font-bold rounded-xl transition-colors shadow-lg shadow-orange-100"
                            >
                                分享 / 儲存圖片
                            </button>
                            <p className="text-[10px] text-center text-stone-400">若無反應請長按圖片儲存</p>
                        </div>
                    </div>
                </div>
            );
        };

        const HiddenReceipt = ({ people, totals, serviceCharge, mode, date, discountType, discountValue, extraChargeName }) => (
            <div id="receipt-capture" style={{ position: 'absolute', top: '-9999px', left: '-9999px', width: '400px', backgroundColor: '#FFF9F0', padding: '30px', fontFamily: 'sans-serif', color: '#4A403A' }}>
                <div style={{ textAlign: 'center', marginBottom: '20px', borderBottom: '2px dashed #D7CCC8', paddingBottom: '20px' }}>
                    <h2 style={{ fontSize: '24px', fontWeight: 'bold', color: '#E07A5F', margin: 0 }}>分帳小幫手明細</h2>
                    <p style={{ fontSize: '12px', color: '#8D7F75', marginTop: '5px' }}>{date}</p>
                </div>
                <div style={{ marginBottom: '20px', fontSize: '14px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '5px' }}><span>餐費小計</span><span style={{ fontWeight: 'bold' }}>{formatCurrency(totals.subtotal)}</span></div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '5px' }}><span>服務費 ({serviceCharge} %)</span><span style={{ fontWeight: 'bold' }}>{formatCurrency(totals.serviceFee)}</span></div>
                    {totals.discount > 0 && <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '5px', color: '#E07A5F' }}>
                        <span>
                            折扣
                            {discountType === DISCOUNT_TYPES.PERCENT && (
                                <span style={{ fontSize: '11px', marginLeft: '4px', fontWeight: 'normal' }}>
                                    ({(100 - parseFloat(discountValue)) / 10}折 / {discountValue} % off) 
                                </span>
                            )}
                        </span>
                        <span style={{ fontWeight: 'bold' }}>-{formatCurrency(totals.discount)}</span>
                    </div>}
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '10px', paddingTop: '10px', borderTop: '1px solid #D7CCC8', fontSize: '18px', fontWeight: 'bold', color: '#E07A5F' }}><span>應付總額</span><span>{formatCurrency(totals.grandTotal)}</span></div>
                </div>
                <div style={{ borderTop: '2px dashed #D7CCC8', paddingTop: '20px', marginBottom: '20px' }}>
                    <h3 style={{ fontSize: '14px', fontWeight: 'bold', marginBottom: '10px', color: '#8D7F75' }}>分攤名單 ({people.length}人)</h3>
                    {people.map((p, i) => (
                        <div key={i} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px', paddingBottom: '8px', borderBottom: '1px solid #EFE6E0' }}>
                            <div>
                                <div style={{ fontWeight: 'bold', fontSize: '16px' }}>{p.name || `朋友 ${i+1}`}</div>
                                <div style={{ fontSize: '10px', color: '#8D7F75' }}>
                                    {mode === MODES.SEPARATE ? `(個$${p.personalAmount} + 公$${Math.round(p.breakdown.shared)}` : '平均分攤'}
                                    {p.breakdown.extra > 0 ? ` + ${extraChargeName || '額'}+$${Math.round(p.breakdown.extra)}` : ''}
                                    {/* 顯示個人分到的折扣金額 */}
                                    {p.breakdown.discount > 0 ? ` - 折$${Math.round(p.breakdown.discount)}` : ''}
                                    {mode === MODES.SEPARATE ? ')' : ''}
                                    {p.weight !== 1 && ` • ${p.weight}份`}
                                </div>
                            </div>
                            <div style={{ fontSize: '18px', fontWeight: 'bold', color: '#4A403A' }}>{formatCurrency(p.finalPay)}</div>
                        </div>
                    ))}
                </div>
                <div style={{ textAlign: 'center', borderTop: '1px solid #EFE6E0', paddingTop: '20px' }}>
                    <img src={PROXY_QR_CODE_URL} crossOrigin="anonymous" style={{ width: '80px', height: '80px', margin: '0 auto 10px', mixBlendMode: 'multiply' }} />
                    <div style={{ fontSize: '10px', color: '#D7CCC8' }}>Generated by 分帳小幫手</div>
                </div>
            </div>
        );

        // --- Main App ---

        function SplitBillApp() {
            const [people, setPeople] = useState([{ id: 1, name: '', personalAmount: 0, weight: 1 }, { id: 2, name: '', personalAmount: 0, weight: 1 }]);
            const [sharedBill, setSharedBill] = useState('');
            const [takeoutBill, setTakeoutBill] = useState('');
            const [extraChargeAmount, setExtraChargeAmount] = useState('');
            const [extraChargeName, setExtraChargeName] = useState('');
            const [extraChargePayers, setExtraChargePayers] = useState([]);
            const [serviceCharge, setServiceCharge] = useState(DEFAULT_SERVICE_CHARGE);
            const [mode, setMode] = useState(MODES.SPLIT_ALL);
            const [discountType, setDiscountType] = useState(DISCOUNT_TYPES.NONE);
            const [discountValue, setDiscountValue] = useState('');
            const [discountTiming, setDiscountTiming] = useState(DISCOUNT_TIMING.AFTER_TAX); 

            // Auto-update check state
            const newVersion = useCheckUpdate();

            // Modal States
            const [showReceipt, setShowReceipt] = useState(false);
            const [receiptImg, setReceiptImg] = useState('');
            const [showShare, setShowShare] = useState(false);
            const [showGuide, setShowGuide] = useState(false);

            const handleDiscountTypeChange = (newType) => { setDiscountType(newType); setDiscountValue(''); };
            
            // Toggle Extra Charge Payer
            const toggleExtraPayer = (id) => {
                setExtraChargePayers(prev => prev.includes(id) ? prev.filter(pid => pid !== id) : [...prev, id]);
            };

            const { peopleResults, totals } = useMemo(() => calculateBill(people, Number(sharedBill) || 0, Number(takeoutBill) || 0, Number(extraChargeAmount) || 0, extraChargePayers, Number(serviceCharge) || 0, mode, discountType, Number(discountValue), discountTiming), [people, sharedBill, takeoutBill, extraChargeAmount, extraChargePayers, serviceCharge, mode, discountType, discountValue, discountTiming]);

            const addPerson = () => { const newId = people.length > 0 ? Math.max(...people.map(p => p.id)) + 1 : 1; setPeople([...people, { id: newId, name: '', personalAmount: 0, weight: 1 }]); };
            const removePerson = (id) => {
                setPeople(people.filter(p => p.id !== id));
                setExtraChargePayers(prev => prev.filter(pid => pid !== id)); // Remove from extra payers if deleted
            };
            const updatePerson = (id, field, value) => setPeople(people.map(p => p.id === id ? { ...p, [field]: value } : p));
            const toggleWeight = (id) => setPeople(people.map(p => p.id === id ? { ...p, weight: p.weight === 1 ? 0.5 : 1 } : p));
            const toggleMode = () => setMode(prev => prev === MODES.SPLIT_ALL ? MODES.SEPARATE : MODES.SPLIT_ALL);
            
            const generateReceipt = async () => {
                const element = document.getElementById('receipt-capture');
                if (!element) return;
                try {
                    // Check if html2canvas is loaded
                    if (typeof html2canvas === 'undefined') {
                        // Load script if not present
                        const script = document.createElement('script');
                        script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
                        script.onload = async () => {
                            const canvas = await html2canvas(element, { scale: 2, useCORS: true, backgroundColor: '#FFF9F0' });
                            setReceiptImg(canvas.toDataURL('image/png'));
                            setShowReceipt(true);
                        };
                        document.head.appendChild(script);
                    } else {
                        const canvas = await html2canvas(element, { scale: 2, useCORS: true, backgroundColor: '#FFF9F0' });
                        setReceiptImg(canvas.toDataURL('image/png'));
                        setShowReceipt(true);
                    }
                } catch (error) { console.error('Screenshot failed:', error); alert('生成圖片失敗，請重試'); }
            };

            return (
                <div className="min-h-screen font-sans p-3 md:p-6 w-full overflow-x-hidden pt-[calc(env(safe-area-inset-top)+0.75rem)]">
                    <div className="max-w-4xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-3 w-full">
                        <div className="lg:col-span-12 mb-1 lg:mb-2">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                    <div className="w-10 h-10 rounded-lg shadow-md shadow-orange-200 overflow-hidden shrink-0">
                                        <img src={PROXY_LOGO_URL} alt="Logo" className="w-full h-full object-cover" />
                                    </div>
                                    <div><h1 className="text-xl font-bold text-[#4A403A] tracking-tight leading-tight">分帳小幫手</h1><p className="text-[10px] text-stone-500 font-medium">{CURRENT_VERSION}</p></div>
                                </div>
                                <div className="flex gap-2">
                                    <HeaderButton icon={Camera} onClick={generateReceipt} label="生成圖片" />
                                    <HeaderButton icon={Share2} onClick={() => setShowShare(true)} label="分享連結" />
                                    <HeaderButton icon={Download} onClick={() => setShowGuide(true)} label="加入桌面" />
                                </div>
                            </div>
                        </div>

                        <div className="lg:col-span-5 space-y-3 w-full">
                            <Card>
                                <div className="flex items-center gap-2 mb-3 text-[#E07A5F] font-bold text-base"><Settings size={18} /><h3>計算設定</h3></div>
                                <div className="space-y-3">
                                    <div><label className="block text-xs font-bold text-stone-600 mb-1">分帳模式</label><ToggleSwitch active={mode === MODES.SPLIT_ALL ? 'left' : 'right'} onClick={toggleMode} leftLabel="全部平分" rightLabel="扣除各別單點" /></div>
                                    <div className="flex gap-3">
                                        <div className="w-28 shrink-0">
                                            <InputGroup label="服務費率" icon={Receipt} value={serviceCharge} onChange={(e) => setServiceCharge(e.target.value)} subLabel="%" />
                                        </div>
                                        <div className="flex-1">
                                            <InputGroup label="共同外帶(免服務費)" icon={Coffee} value={takeoutBill} onChange={(e) => setTakeoutBill(e.target.value)} placeholder="0" />
                                        </div>
                                    </div>
                                </div>
                            </Card>
                            <Card className="border-l-4 border-l-[#E07A5F]">
                                <div className="flex items-center gap-2 mb-3 text-[#E07A5F] font-bold text-base"><DollarSign size={18} /><h3>{mode === MODES.SPLIT_ALL ? '總金額 (未稅)' : '共同分食 (未稅)'}</h3></div>
                                <InputGroup label={mode === MODES.SPLIT_ALL ? "帳單總金額" : "大家一起吃的金額"} value={sharedBill} onChange={(e) => setSharedBill(e.target.value)} placeholder="輸入金額" className="text-lg font-bold text-[#E07A5F]" />
                                <p className="mt-2 mb-4 text-[10px] text-stone-500 font-medium bg-[#FFF9F0] p-2 rounded border border-[#E6D5C8] leading-tight">{mode === MODES.SPLIT_ALL ? "含服務費後平均分配。" : "加收服務費後分配。個人部分請在右側輸入。"}</p>
                                
                                {/* 額外加點模組 */}
                                <ExtraChargeModule 
                                    name={extraChargeName}
                                    onNameChange={(e) => setExtraChargeName(e.target.value)}
                                    amount={extraChargeAmount} 
                                    onAmountChange={(e) => setExtraChargeAmount(e.target.value)} 
                                    people={people} 
                                    selectedIds={extraChargePayers} 
                                    onTogglePerson={toggleExtraPayer} 
                                />

                                <DiscountSelector type={discountType} onChangeType={handleDiscountTypeChange} value={discountValue} onChangeValue={(e) => setDiscountValue(e.target.value)} timing={discountTiming} onChangeTiming={setDiscountTiming} />
                            </Card>
                            <Card className="!bg-[#3D405B] text-white border-none shadow-xl shadow-stone-300 hidden lg:block">
                                <div className="space-y-3">
                                    <div className="flex justify-between items-end border-b border-white/20 pb-3"><span className="text-white/80 font-medium text-sm">應付總額</span><span className="text-3xl font-bold tracking-tight text-white">{formatCurrency(totals.grandTotal)}</span></div>
                                    <div className="grid grid-cols-2 gap-4 text-xs text-white/80"><div><span className="block opacity-60 mb-0.5">餐費小計</span><span className="font-semibold text-white text-base">{formatCurrency(totals.subtotal)}</span></div><div><span className="block opacity-60 mb-0.5">服務費總計</span><span className="font-semibold text-white text-base">{formatCurrency(totals.serviceFee)}</span></div></div>
                                    {totals.discount > 0 && <div className="pt-2 border-t border-white/20 text-xs text-[#E07A5F] flex justify-between"><span>已扣除折扣</span><span>-{formatCurrency(totals.discount)}</span></div>}
                                </div>
                            </Card>
                        </div>

                        <div className="lg:col-span-7 space-y-3 w-full">
                            <Card className="flex flex-col h-auto">
                                <div className="flex justify-between items-center mb-4"><div className="flex items-center gap-2 text-[#E07A5F] font-bold text-base"><User size={18} /><h3>名單 ({people.length}人)</h3></div><button onClick={addPerson} className="flex items-center gap-1 bg-[#FFF0E6] hover:bg-[#FFE0CC] text-[#E07A5F] px-2.5 py-1 rounded-md text-xs font-bold transition-colors"><Plus size={14} /> 增加</button></div>
                                <div className="space-y-2">
                                    {people.map((person, index) => (
                                        <div key={person.id} className="group flex flex-col sm:flex-row items-center gap-2 p-2 rounded-lg hover:bg-[#FFF9F0] border border-transparent hover:border-[#E6D5C8] transition-all bg-white/50 sm:bg-transparent">
                                            <div className="flex items-center gap-2 w-full sm:w-auto flex-1">
                                                <button onClick={() => removePerson(person.id)} className="text-stone-300 hover:text-red-500 transition-colors p-1" title="移除"><Trash2 size={16} /></button>
                                                <div className="flex-1 flex items-center gap-2">
                                                    <div className={`w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold shrink-0 ${getAvatarStyle(index)}`}>{index + 1}</div>
                                                    <div className="relative flex-1"><input type="text" value={person.name} onChange={(e) => updatePerson(person.id, 'name', e.target.value)} className="w-full bg-[#FFFCF9] border border-[#E6D5C8] focus:border-[#E07A5F] rounded-md px-3 py-1.5 text-stone-800 font-bold text-sm outline-none shadow-sm placeholder-stone-300 transition-all" placeholder={`輸入姓名`} /></div>
                                                    <button onClick={() => toggleWeight(person.id)} className={`shrink-0 px-2 py-1.5 rounded-md text-xs font-bold border transition-all w-12 text-center ${person.weight === 1 ? 'bg-[#F2F2F2] text-stone-500 border-[#D7CCC8] hover:bg-[#E6E6E6]' : 'bg-[#FFE0CC] text-[#E07A5F] border-[#FFCCBC] ring-1 ring-orange-100'}`} title="點擊切換份量">x{person.weight}</button>
                                                </div>
                                            </div>
                                            {mode === MODES.SEPARATE && <div className="w-full sm:w-28 pl-8 sm:pl-0"><div className="relative"><span className="absolute left-2 top-1/2 -translate-y-1/2 text-stone-400 text-[10px] font-bold">$</span><input type="number" placeholder="個人" value={person.personalAmount || ''} onChange={(e) => updatePerson(person.id, 'personalAmount', e.target.value)} className="w-full pl-5 pr-2 py-1.5 text-sm bg-[#FFFCF9] border border-[#E6D5C8] rounded-md focus:ring-2 focus:ring-[#E07A5F] outline-none text-right font-medium text-stone-700" /></div></div>}
                                            <div className="w-full sm:w-auto sm:min-w-[100px] text-right flex justify-between sm:block items-center pl-8 sm:pl-0">
                                                <span className="text-xs text-stone-500 font-bold sm:hidden">應付</span>
                                                <div>
                                                    <span className="text-base font-bold text-[#E07A5F] block leading-tight">{formatCurrency(peopleResults.find(p => p.id === person.id)?.finalPay || 0)}</span>
                                                    <div className="text-[9px] text-stone-400 font-medium hidden sm:block">
                                                        {mode === MODES.SEPARATE ? `(共食+${Math.round(peopleResults.find(p => p.id === person.id)?.breakdown.shared || 0)}` : ''}
                                                        {peopleResults.find(p => p.id === person.id)?.breakdown.extra > 0 ? (mode === MODES.SEPARATE ? ` + ${extraChargeName || '額'}+$${Math.round(peopleResults.find(p => p.id === person.id)?.breakdown.extra)}` : `(額外+${Math.round(peopleResults.find(p => p.id === person.id)?.breakdown.extra)})`) : ''}
                                                        {/* 顯示個人分到的折扣金額 */}
                                                        {peopleResults.find(p => p.id === person.id)?.breakdown.discount > 0 ? ` - 折$${Math.round(peopleResults.find(p => p.id === person.id)?.breakdown.discount)}` : ''}
                                                        {mode === MODES.SEPARATE ? ')' : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    {people.length === 0 && <div className="text-center py-8 text-stone-400"><User size={32} className="mx-auto mb-2 opacity-20" /><p className="text-xs">點擊「增加」開始分帳</p></div>}
                                </div>
                                <div className="mt-6 pt-4 border-t border-[#E6D5C8]"><h4 className="text-sm font-bold text-[#E07A5F] mb-2 flex items-center gap-1"><span className="text-lg">💡</span> 小幫手特點</h4><ul className="text-xs text-stone-500 space-y-1 pl-1"><li className="flex items-start gap-1.5"><span className="mt-0.5 w-1 h-1 rounded-full bg-[#E07A5F] shrink-0"></span><span><span className="font-bold text-stone-600">彈性模式</span>：隨意切換「全體平分」或「各付各的」。</span></li><li className="flex items-start gap-1.5"><span className="mt-0.5 w-1 h-1 rounded-full bg-[#E07A5F] shrink-0"></span><span><span className="font-bold text-stone-600">智慧折扣</span>：支援服務費前/後扣抵，精準計算不吃虧。</span></li><li className="flex items-start gap-1.5"><span className="mt-0.5 w-1 h-1 rounded-full bg-[#E07A5F] shrink-0"></span><span><span className="font-bold text-stone-600">份量權重</span>：點擊按鈕切換 x1 (正常) 或 x0.5 (小孩)。</span></li><li className="flex items-start gap-1.5"><span className="mt-0.5 w-1 h-1 rounded-full bg-[#E07A5F] shrink-0"></span><span><span className="font-bold text-stone-600">明細存圖</span>：右上角相機按鈕，一鍵生成美觀帳單分享。</span></li><li className="flex items-start gap-1.5"><span className="mt-0.5 w-1 h-1 rounded-full bg-[#E07A5F] shrink-0"></span><span><span className="font-bold text-stone-600">加入桌面</span>：隱藏網址列，享受全螢幕 App 體驗。</span></li></ul></div>
                            </Card>
                            {/* Mobile Summary Card (Updated Layout) */}
                            <Card className="!bg-[#3D405B] text-white border-none shadow-xl shadow-stone-300 lg:hidden mt-2">
                                <div className="space-y-3">
                                    <div className="text-xs text-white/70 space-y-1">
                                        <div className="flex justify-between">
                                            <span>餐費小計</span>
                                            <span>{formatCurrency(totals.subtotal)}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span>+ 服務費</span>
                                            <span>{formatCurrency(totals.serviceFee)}</span>
                                        </div>
                                        {totals.discount > 0 && (
                                            <div className="flex justify-between text-[#E07A5F]">
                                                <span>- 折扣</span>
                                                <span>{formatCurrency(totals.discount)}</span>
                                            </div>
                                        )}
                                    </div>
                                    <div className="border-t border-white/20 pt-2 flex justify-between items-end">
                                        <span className="font-bold text-sm text-white/90">應付總額</span>
                                        <span className="text-2xl font-bold text-white leading-none">{formatCurrency(totals.grandTotal)}</span>
                                    </div>
                                </div>
                            </Card>
                        </div>
                    </div>

                    <HiddenReceipt people={peopleResults} totals={totals} serviceCharge={serviceCharge} mode={mode} date={formatDate()} discountType={discountType} discountValue={discountValue} extraChargeName={extraChargeName} />
                    <ReceiptModal isOpen={showReceipt} onClose={() => setShowReceipt(false)} imgSrc={receiptImg} />
                    <ShareModal isOpen={showShare} onClose={() => setShowShare(false)} />
                    <GuideModal isOpen={showGuide} onClose={() => setShowGuide(false)} />
                    
                    {/* Update Notification Banner */}
                    {newVersion && (
                        <div className="fixed bottom-4 left-4 right-4 bg-[#3D405B] text-white p-3 rounded-xl shadow-2xl z-50 flex justify-between items-center animate-[slideUp_0.3s_ease-out]">
                            <div className="flex items-center gap-2 text-sm">
                                <RefreshCw className="animate-spin text-[#E07A5F]" size={18} />
                                <span>發現新版本 {newVersion}</span>
                            </div>
                            <button 
                                onClick={() => window.location.reload(true)} 
                                className="bg-[#E07A5F] hover:bg-[#D0654B] text-white text-xs font-bold px-3 py-1.5 rounded-lg transition-colors"
                            >
                                立即更新
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SplitBillApp />);
    </script>
</body>
</html>